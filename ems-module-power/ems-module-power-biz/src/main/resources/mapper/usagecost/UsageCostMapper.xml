<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.bitlinks.ems.module.power.dal.mysql.usagecost.UsageCostMapper">

    <!--
        一般情况下，尽可能使用 Mapper 进行 CRUD 增删改查即可。
        无法满足的场景，例如说多表关联查询，才使用 XML 编写 SQL。
        代码生成器暂时只生成 Mapper XML 文件本身，更多推荐 MybatisX 快速开发插件来生成查询。
        文档可见：https://www.bitlinks.cn/MyBatis/x-plugins/
     -->
    <resultMap id="UsageCostDataResultMap" type="cn.bitlinks.ems.module.power.controller.admin.statistics.vo.UsageCostData">
        <result column="standingbook_id" property="standingbookId" />
        <result column="time" property="time" />
        <result column="energy_id" property="energyId" />
        <result column="currentTotalUsage" property="currentTotalUsage" />
        <result column="totalCost" property="totalCost" />
    </resultMap>

    <!-- 参数说明：aggregateType (聚合类型)，startDate (起始日期)，endDate (结束日期) -->
    <select id="getList" resultType="cn.bitlinks.ems.module.power.controller.admin.statistics.vo.UsageCostData">
        <!-- 参数说明：
          - dateType (聚合类型，0: 按日, 1: 按月, 2: 按年, 3: 按时)
          - queryType (分组字段，0: 按 standingbook_id, 1: 按 energy_id, 2: 按 tag_id)
          - startDate (起始日期)
          - endDate (结束日期)
        -->
        SELECT
        <choose>
            <!-- 根据 queryType 选择分组字段 -->
            <when test="queryParam.queryType == 0 || queryParam.queryType == 2">
                standingbook_id,energy_id
            </when>
            <when test="queryParam.queryType == 1">
                energy_id
            </when>

        </choose>
        ,
        <choose>
            <!-- 根据 dateType 选择聚合字段 -->
            <when test="queryParam.dateType == 0">
                DATE(aggregate_time) AS time
            </when>
            <when test="queryParam.dateType == 1">
                DATE_FORMAT(aggregate_time, '%Y-%m') AS time
            </when>
            <when test="queryParam.dateType == 2">
                YEAR(aggregate_time) AS time
            </when>
            <when test="queryParam.dateType == 3">
                DATE_FORMAT(aggregate_time, '%Y-%m-%d %H:00:00') AS time
            </when>
        </choose>
        ,
        SUM(
            CASE
                WHEN cost = -1 THEN NULL
            ELSE cost
            END
        ) AS totalCost,
        SUM(current_usage) AS currentTotalUsage,
        SUM(
            CASE
                WHEN standard_coal_equivalent = -1 THEN NULL
            ELSE standard_coal_equivalent
            END
        ) AS totalStandardCoalEquivalent
        FROM
        usage_cost
        WHERE
        aggregate_time &gt;= #{startDate}
        AND aggregate_time &lt;= #{endDate}
            AND standingbook_id IN
            <foreach collection="standingBookIds" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        GROUP BY
        <choose>
            <!-- 根据 queryType 选择分组字段 -->
            <when test="queryParam.queryType == 0 || queryParam.queryType == 2">
                standingbook_id,energy_id
            </when>
            <when test="queryParam.queryType == 1">
                energy_id
            </when>
        </choose>
        ,

        <choose>
            <!-- 根据 dateType 选择聚合字段 -->
            <when test="queryParam.dateType == 0">
                DATE(aggregate_time)
            </when>
            <when test="queryParam.dateType == 1">
                DATE_FORMAT(aggregate_time, '%Y-%m')
            </when>
            <when test="queryParam.dateType == 2">
                YEAR(aggregate_time)
            </when>
            <when test="queryParam.dateType == 3">
                DATE_FORMAT(aggregate_time, '%Y-%m-%d %H:00:00')
            </when>
        </choose>

    </select>
    <select id="getLastTime2" resultType="java.time.LocalDateTime">

        SELECT
        MAX(aggregate_time) AS lastTime
        FROM
        usage_cost
        WHERE
        aggregate_time &gt;= #{startDate}
        AND aggregate_time &lt;= #{endDate}
        AND standingbook_id IN
        <foreach collection="standingBookIds" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>

    </select>

    <select id="getLastTime" resultType="java.time.LocalDateTime">
        <!-- 参数说明：
          - dateType (聚合类型，0: 按日, 1: 按月, 2: 按年, 3: 按时)
          - queryType (分组字段，0: 按 standingbook_id, 1: 按 energy_id, 2: 按 tag_id)
          - startDate (起始日期)
          - endDate (结束日期)
        -->
        SELECT
        MAX(aggregate_time) AS lastTime
        FROM
        usage_cost
        WHERE
        aggregate_time &gt;= #{startDate}
        AND aggregate_time &lt;= #{endDate}
        AND standingbook_id IN
        <foreach collection="standingBookIds" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>


    </select>



    <select id="getListOfHome" resultType="cn.bitlinks.ems.module.power.controller.admin.statistics.vo.UsageCostData">
        SELECT
        energy_id,
        SUM(
            CASE
                WHEN cost = -1 THEN NULL
            ELSE cost
        END
        ) AS totalCost,
        SUM(current_usage) AS currentTotalUsage,
        SUM(
            CASE
                WHEN standard_coal_equivalent = -1 THEN NULL
            ELSE standard_coal_equivalent
            END
        ) AS totalStandardCoalEquivalent
        FROM
        usage_cost
        WHERE
        DATE_FORMAT(aggregate_time, '%Y-%m-%d')  &gt; #{startDate}
        AND DATE_FORMAT(aggregate_time, '%Y-%m-%d')  &lt;= #{endDate}

        AND energy_id IN
        <foreach collection="energyIdList" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
        GROUP BY
        energy_id

    </select>


    <select id="getEnergyAndSbStandardCoal" resultType="cn.bitlinks.ems.module.power.controller.admin.statistics.vo.UsageCostData">
        SELECT
        energy_id,
        standingbook_id,
        SUM(
            CASE
                WHEN standard_coal_equivalent = -1 THEN NULL
            ELSE standard_coal_equivalent
            END
        ) AS totalStandardCoalEquivalent
        FROM
        usage_cost
        WHERE

        aggregate_time &gt;= #{startDate}
        AND aggregate_time &lt;= #{endDate}
        AND standingbook_id IN
        <foreach collection="standingBookIds" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
        group by energy_id,standingbook_id

  </select>

    <select id="getEnergyStandardCoal" resultType="cn.bitlinks.ems.module.power.controller.admin.statistics.vo.UsageCostData">
        SELECT
        energy_id,
        SUM(
            CASE
                WHEN standard_coal_equivalent = -1 THEN NULL
            ELSE standard_coal_equivalent
            END
        ) AS totalStandardCoalEquivalent
        FROM
        usage_cost
        WHERE
        aggregate_time &gt;= #{startDate}
        AND aggregate_time &lt;= #{endDate}
        AND standingbook_id IN
        <foreach collection="standingBookIds" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
        group by energy_id

    </select>
    <select id="getEnergyStandardCoalByEnergyIds" resultMap="UsageCostDataResultMap">
        SELECT energy_id,
        SUM(
        CASE
        WHEN cost = -1 THEN NULL
        ELSE cost
        END
        ) AS totalCost,
        SUM(current_usage) AS currentTotalUsage,
        SUM(
        CASE
        WHEN standard_coal_equivalent = -1 THEN NULL
        ELSE standard_coal_equivalent
        END
        ) AS totalStandardCoalEquivalent
        FROM usage_cost
        WHERE aggregate_time &gt;= #{startDate}
        AND aggregate_time &lt;= #{endDate}
        AND energy_id IN
        <foreach collection="energyIds" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
        group by energy_id
    </select>

    <select id="getEnergySumStandardCoal" resultType="java.math.BigDecimal">
        SELECT
        SUM(
        CASE
        WHEN standard_coal_equivalent &lt; 0 THEN NULL
        ELSE standard_coal_equivalent
        END
        ) AS totalStandardCoalEquivalent
        FROM
        usage_cost
        WHERE
        aggregate_time &gt;= #{startDate}
        AND aggregate_time &lt;= #{endDate}
        <if test="energyIds != null and energyIds.size() > 0">
            AND energy_id IN
            <foreach collection="energyIds" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
    </select>

    <select id="getStandingbookStandardCoal" resultType="cn.bitlinks.ems.module.power.controller.admin.statistics.vo.UsageCostData">
        SELECT
        standingbook_id,
        SUM(
        CASE
        WHEN standard_coal_equivalent = -1 THEN NULL
        ELSE standard_coal_equivalent
        END
        ) AS totalStandardCoalEquivalent
        FROM
        usage_cost
        WHERE
        aggregate_time &gt;= #{startDate}
        AND aggregate_time &lt;= #{endDate}

        AND standingbook_id IN
        <foreach collection="standingBookIds" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
        group by standingbook_id

    </select>
    <select id="getUsageByStandingboookIdGroup" resultType="cn.bitlinks.ems.module.power.controller.admin.statistics.vo.UsageCostData">
        SELECT
                standingbook_id,energy_id,
        <choose>
            <!-- 根据 dateType 选择聚合字段 -->
            <when test="queryParam.dateType == 0">
                DATE(aggregate_time) AS time
            </when>
            <when test="queryParam.dateType == 1">
                DATE_FORMAT(aggregate_time, '%Y-%m') AS time
            </when>
            <when test="queryParam.dateType == 2">
                YEAR(aggregate_time) AS time
            </when>
            <when test="queryParam.dateType == 3">
                DATE_FORMAT(aggregate_time, '%Y-%m-%d %H:00:00') AS time
            </when>
        </choose>
        ,
        SUM(current_usage) AS currentTotalUsage
        FROM
        usage_cost
        WHERE
        aggregate_time &gt;= #{startDate}
        AND aggregate_time &lt;= #{endDate}
        AND standingbook_id IN
        <foreach collection="standingBookIds" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
        GROUP BY
            standingbook_id,energy_id
        <choose>
            <!-- 根据 dateType 选择聚合字段 -->
            <when test="queryParam.dateType == 0">
               , DATE(aggregate_time)
            </when>
            <when test="queryParam.dateType == 1">
               , DATE_FORMAT(aggregate_time, '%Y-%m')
            </when>
            <when test="queryParam.dateType == 2">
               , YEAR(aggregate_time)
            </when>
            <when test="queryParam.dateType == 3">
               , DATE_FORMAT(aggregate_time, '%Y-%m-%d %H:00:00')
            </when>
        </choose>

    </select>

    <select id="getTimeDataList" resultType="cn.bitlinks.ems.module.power.controller.admin.statistics.vo.UsageCostData">
        <!-- 参数说明：
          - dateType (聚合类型，0: 按日, 1: 按月, 2: 按年, 3: 按时)
          - startDate (起始日期)
          - endDate (结束日期)
        -->
        SELECT
        standingbook_id,
        <choose>
            <!-- 根据 dateType 选择聚合字段 -->
            <when test="dateType == 0">
                DATE(aggregate_time) AS time
            </when>
            <when test="dateType == 1">
                DATE_FORMAT(aggregate_time, '%Y-%m') AS time
            </when>
            <when test="dateType == 2">
                YEAR(aggregate_time) AS time
            </when>
            <when test="dateType == 3">
                DATE_FORMAT(aggregate_time, '%Y-%m-%d %H:00:00') AS time
            </when>
        </choose>
        ,
        SUM(current_usage)            AS currentTotalUsage

        FROM usage_cost
        WHERE aggregate_time &gt;= #{startDate}
        AND aggregate_time &lt;= #{endDate}
        AND standingbook_id IN
        <foreach collection="standingBookIds" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
        GROUP BY standingbook_id,
        <choose>
            <!-- 根据 dateType 选择聚合字段 -->
            <when test="dateType == 0">
                DATE(aggregate_time)
            </when>
            <when test="dateType == 1">
                DATE_FORMAT(aggregate_time, '%Y-%m')
            </when>
            <when test="dateType == 2">
                YEAR(aggregate_time)
            </when>
            <when test="dateType == 3">
                DATE_FORMAT(aggregate_time, '%Y-%m-%d %H:00:00')
            </when>
        </choose>
    </select>

    <select id="getDataList" resultType="cn.bitlinks.ems.module.power.controller.admin.statistics.vo.UsageCostData">
        <!-- 参数说明：
          - dateType (聚合类型，0: 按日, 1: 按月, 2: 按年, 3: 按时)
          - startDate (起始日期)
          - endDate (结束日期)
        -->
        SELECT
        standingbook_id,
        SUM(current_usage)            AS currentTotalUsage

        FROM usage_cost
        WHERE aggregate_time &gt;= #{startDate}
        AND aggregate_time &lt;= #{endDate}
        AND standingbook_id IN
        <foreach collection="standingBookIds" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
        GROUP BY standingbook_id
    </select>

    <select id="getEnergyUsage" resultMap="UsageCostDataResultMap">
        <!-- 参数说明：
      - dateType (聚合类型，0: 按日, 1: 按月, 2: 按年, 3: 按时)
      - startDate (起始日期)
      - endDate (结束日期)
    -->
        SELECT
        <choose>
            <!-- 根据 dateType 选择聚合字段 -->
            <when test="dateType == 0">
                DATE(aggregate_time) AS time
            </when>
            <when test="dateType == 1">
                DATE_FORMAT(aggregate_time, '%Y-%m') AS time
            </when>
            <when test="dateType == 2">
                YEAR(aggregate_time) AS time
            </when>
            <when test="dateType == 3">
                DATE_FORMAT(aggregate_time, '%Y-%m-%d %H:00:00') AS time
            </when>
        </choose>
        ,
        SUM(current_usage)            AS currentTotalUsage

        FROM usage_cost
        WHERE aggregate_time &gt;= #{startDate}
        AND aggregate_time &lt;= #{endDate}
        AND standingbook_id IN
        <foreach collection="standingBookIds" item="item" open="(" separator="," close=")">
            #{item}
        </foreach>
        GROUP BY
        <choose>
            <!-- 根据 dateType 选择聚合字段 -->
            <when test="dateType == 0">
                DATE(aggregate_time)
            </when>
            <when test="dateType == 1">
                DATE_FORMAT(aggregate_time, '%Y-%m')
            </when>
            <when test="dateType == 2">
                YEAR(aggregate_time)
            </when>
            <when test="dateType == 3">
                DATE_FORMAT(aggregate_time, '%Y-%m-%d %H:00:00')
            </when>
        </choose>
    </select>
    <select id="getSumStandardCoal"
            resultType="java.math.BigDecimal">
        SELECT
        SUM(standard_coal_equivalent) AS totalStandardCoalEquivalent
        FROM
        usage_cost
        WHERE
        aggregate_time &gt;= #{startDate}
        AND aggregate_time &lt;= #{endDate}
        <if test="standingBookIds != null and standingBookIds.size() > 0">
            AND standingbook_id IN
            <foreach collection="standingBookIds" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>

    </select>
</mapper>

