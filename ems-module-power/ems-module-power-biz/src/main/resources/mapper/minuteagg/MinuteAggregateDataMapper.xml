<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.bitlinks.ems.module.power.dal.mysql.minuteagg.MinuteAggregateDataMapper">


    <resultMap id="BaseResultMap"
               type="cn.bitlinks.ems.module.power.dal.dataobject.minuteagg.MinuteAggregateDataDO">
        <result column="data_site" property="dataSite"/>
        <result column="aggregate_time" property="aggregateTime"/>
        <result column="param_code" property="paramCode"/>
        <result column="energy_flag" property="energyFlag"/>
        <result column="standingbook_id" property="standingbookId"/>
        <result column="full_value" property="fullValue"/>
        <result column="incremental_value" property="incrementalValue"/>
        <result column="full_increment" property="fullIncrement"/>
        <result column="data_feature" property="dataFeature"/>
        <result column="data_type" property="dataType"/>
        <result column="usage" property="usage"/>
        <result column="acq_flag" property="acqFlag"/>

    </resultMap>

    <select id="getTmpRangeDataSteady"
            resultType="cn.bitlinks.ems.module.power.dal.dataobject.minuteagg.MinuteAggregateDataDO">
        WITH ranked_data AS (
        SELECT *,
        ROW_NUMBER() OVER (
        PARTITION BY standingbook_id, param_code, DATE_TRUNC('hour', aggregate_time)
        ORDER BY aggregate_time DESC
        ) AS rn
        FROM minute_aggregate_data
        WHERE
        aggregate_time >= #{starTime}
        AND aggregate_time &lt; #{endTime}
        <if test="standingbookIds != null and standingbookIds.size() != 0">
            AND standingbook_id IN
            <foreach collection="standingbookIds" item="id" open="(" separator="," close=")">
                #{id}
            </foreach>
        </if>
        <if test="paramCodes != null and paramCodes.size() != 0">
            AND param_code IN
            <foreach collection="paramCodes" item="paramCode" open="(" separator="," close=")">
                #{paramCode}
            </foreach>
        </if>
        )
        SELECT
        standingbook_id,
        param_code,
        full_value,
        DATE_ADD(DATE_FORMAT(aggregate_time, '%Y-%m-%d %H:00:00'), INTERVAL 1 HOUR) AS aggregate_time
        FROM ranked_data
        WHERE rn = 1
        ORDER BY standingbook_id, param_code, aggregate_time;

    </select>

</mapper>

