<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="cn.bitlinks.ems.module.power.dal.mysql.minuteagg.MinuteAggregateDataMapper">


    <resultMap id="BaseResultMap"
               type="cn.bitlinks.ems.module.power.dal.dataobject.minuteagg.MinuteAggregateDataDO">
        <result column="data_site" property="dataSite"/>
        <result column="aggregate_time" property="aggregateTime"/>
        <result column="param_code" property="paramCode"/>
        <result column="energy_flag" property="energyFlag"/>
        <result column="standingbook_id" property="standingbookId"/>
        <result column="full_value" property="fullValue"/>
        <result column="incremental_value" property="incrementalValue"/>
        <result column="full_increment" property="fullIncrement"/>
        <result column="data_feature" property="dataFeature"/>
        <result column="data_type" property="dataType"/>
        <result column="usage" property="usage"/>
        <result column="acq_flag" property="acqFlag"/>

    </resultMap>

    <!-- 根据台账ID、参数编码和时间范围查询数据 -->
    <select id="selectByStandingbookIdsAndParamCodes" resultMap="BaseResultMap">
        SELECT *
        FROM minute_aggregate_data
        WHERE standingbook_id IN
        <foreach collection="standingbookIds" item="standingbookId" open="(" separator="," close=")">
            #{standingbookId}
        </foreach>
        AND param_code IN
        <foreach collection="paramCodes" item="paramCode" open="(" separator="," close=")">
            #{paramCode}
        </foreach>
        AND aggregate_time BETWEEN #{startTime} AND #{endTime}
        AND energy_flag=1
        ORDER BY standingbook_id, param_code, aggregate_time
    </select>

    <!-- 根据台账ID、参数编码和日期区间查询当天最后一分钟的数据 -->
    <select id="selectLastMinuteDataByDate" resultMap="BaseResultMap">
        SELECT m1.*
        FROM minute_aggregate_data m1
        INNER JOIN (
        SELECT standingbook_id, param_code, MAX(aggregate_time) as max_time
        FROM minute_aggregate_data
        WHERE standingbook_id IN
        <foreach collection="standingbookIds" item="standingbookId" open="(" separator="," close=")">
            #{standingbookId}
        </foreach>
        AND param_code IN
        <foreach collection="paramCodes" item="paramCode" open="(" separator="," close=")">
            #{paramCode}
        </foreach>
        AND aggregate_time &gt;= #{startTime} AND aggregate_time &lt; #{endTime}
        AND energy_flag=1
        GROUP BY standingbook_id, param_code
        ) m2 ON m1.standingbook_id = m2.standingbook_id
        AND m1.param_code = m2.param_code
        AND m1.aggregate_time = m2.max_time
    </select>

    <!-- 根据台账ID、参数编码和日期区间查询当天所有增量数据之和 -->
    <select id="selectIncrementalSumByDate" resultMap="BaseResultMap">
        SELECT
        standingbook_id,
        param_code,
        #{startTime} as aggregate_time,
        SUM(incremental_value) as incremental_value,
        SUM(full_value) as full_value
        FROM minute_aggregate_data
        WHERE standingbook_id IN
        <foreach collection="standingbookIds" item="standingbookId" open="(" separator="," close=")">
            #{standingbookId}
        </foreach>
        AND param_code IN
        <foreach collection="paramCodes" item="paramCode" open="(" separator="," close=")">
            #{paramCode}
        </foreach>
        AND aggregate_time &gt;= #{startTime} AND aggregate_time &lt; #{endTime}
        AND energy_flag=1
        GROUP BY standingbook_id, param_code
    </select>
    <!--    获取时间维度下，最大值-->
    <select id="getMaxDataGpByDateType"
            resultType="cn.bitlinks.ems.module.power.dal.dataobject.minuteagg.MinuteAggregateDataDO">
        SELECT
        standingbook_id,param_code
        <choose>
            <!-- 根据 dateType 选择聚合字段 -->
            <when test="queryParam.dateType == 0">
                ,DATE(aggregate_time) AS time
            </when>
            <when test="queryParam.dateType == 1">
                ,DATE_FORMAT(aggregate_time, '%Y-%m') AS time
            </when>
            <when test="queryParam.dateType == 2">
                ,YEAR(aggregate_time) AS time
            </when>
            <when test="queryParam.dateType == 3">
                ,DATE_FORMAT(aggregate_time, '%Y-%m-%d %H') AS time
            </when>
        </choose>
        ,
        MAX(full_value) AS full_value
        FROM minute_aggregate_data
        WHERE aggregate_time >= #{starTime}
        AND aggregate_time &lt; #{endTime}
        AND data_feature = 2
        AND energy_flag = 1
        <if test="standingBookIds != null and standingBookIds.size() != 0">
            AND standingbook_id IN
            <foreach collection="standingBookIds" item="item" open="(" separator="," close=")">
                #{item}
            </foreach>
        </if>
        <if test="paramCodes != null and paramCodes.size() != 0">
            AND param_code IN
            <foreach collection="paramCodes" item="paramCode" open="(" separator="," close=")">
                #{paramCode}
            </foreach>
        </if>
        GROUP BY
        standingbook_id,param_code
        <choose>
            <!-- 根据 dateType 选择聚合字段 -->
            <when test="dateType == 0">
                ,DATE(aggregate_time)
            </when>
            <when test="dateType == 1">
                ,DATE_FORMAT(aggregate_time, '%Y-%m')
            </when>
            <when test="dateType == 2">
                ,YEAR(aggregate_time)
            </when>
            <when test="dateType == 3">
                ,DATE_FORMAT(aggregate_time, '%Y-%m-%d %H')
            </when>
        </choose>
    </select>
    <!-- 批量查询逐日的最后一分钟数据 - 修正为按天取最后一条 -->
    <select id="selectLastMinuteDataByDateBatch" resultMap="BaseResultMap">
        SELECT standingbook_id,
        param_code,
        DATE(aggregate_time) AS aggregate_time,
        full_value,
        incremental_value,
        data_site,
        energy_flag,
        full_increment,
        data_feature,
        data_type,
        usage,
        acq_flag
        FROM (
        SELECT standingbook_id,
        param_code,
        aggregate_time,
        full_value,
        incremental_value,
        data_site,
        energy_flag,
        full_increment,
        data_feature,
        data_type,
        usage,
        acq_flag,
        ROW_NUMBER() OVER (
        PARTITION BY standingbook_id, param_code, DATE(aggregate_time)
        ORDER BY aggregate_time DESC
        ) AS rn
        FROM minute_aggregate_data
        WHERE standingbook_id IN
        <foreach collection="standingbookIds" item="standingbookId" open="(" separator="," close=")">
            #{standingbookId}
        </foreach>
        AND param_code IN
        <foreach collection="paramCodes" item="paramCode" open="(" separator="," close=")">
            #{paramCode}
        </foreach>
        AND aggregate_time &gt;= #{startTime} AND aggregate_time &lt; #{endTime}
        AND energy_flag=1
        ) t
        WHERE rn = 1
        ORDER BY standingbook_id, param_code, aggregate_time
    </select>

    <!-- 批量查询增量数据之和 - 性能优化版本 -->
    <select id="selectIncrementalSumByDateBatch" resultMap="BaseResultMap">
        SELECT
        standingbook_id,
        param_code,
        DATE(aggregate_time) as aggregate_time,
        SUM(incremental_value) as incremental_value,
        SUM(full_value) as full_value
        FROM minute_aggregate_data
        WHERE standingbook_id IN
        <foreach collection="standingbookIds" item="standingbookId" open="(" separator="," close=")">
            #{standingbookId}
        </foreach>
        AND param_code IN
        <foreach collection="paramCodes" item="paramCode" open="(" separator="," close=")">
            #{paramCode}
        </foreach>
        AND aggregate_time &gt;= #{startTime} AND aggregate_time &lt; #{endTime}
        AND energy_flag=1
        GROUP BY standingbook_id, param_code, DATE(aggregate_time)
    </select>

    <select id="getTmpRangeDataSteady"
            resultType="cn.bitlinks.ems.module.power.dal.dataobject.minuteagg.MinuteAggregateDataDO">
        WITH ranked_data AS (
        SELECT *,
        ROW_NUMBER() OVER (
        PARTITION BY standingbook_id, param_code, DATE_TRUNC('hour', aggregate_time)
        ORDER BY aggregate_time DESC
        ) AS rn
        FROM minute_aggregate_data
        WHERE
        aggregate_time >= #{starTime}
        AND aggregate_time &lt; #{endTime}
        AND data_feature = 2
        AND energy_flag = 1
        <if test="standingbookIds != null and standingbookIds.size() != 0">
            AND standingbook_id IN
            <foreach collection="standingbookIds" item="id" open="(" separator="," close=")">
                #{id}
            </foreach>
        </if>
        <if test="paramCodes != null and paramCodes.size() != 0">
            AND param_code IN
            <foreach collection="paramCodes" item="paramCode" open="(" separator="," close=")">
                #{paramCode}
            </foreach>
        </if>
        )
        SELECT
        standingbook_id,
        param_code,
        full_value,
        DATE_ADD(DATE_FORMAT(aggregate_time, '%Y-%m-%d %H:00:00'), INTERVAL 1 HOUR) AS aggregate_time
        FROM ranked_data
        WHERE rn = 1
        ORDER BY standingbook_id, param_code, aggregate_time;

    </select>

    <select id="getLastTime" resultType="java.time.LocalDateTime">
        SELECT MAX(aggregate_time) AS lastTime
        FROM minute_aggregate_data
        WHERE aggregate_time >= #{starTime}
        AND aggregate_time &lt; #{endTime}
        AND data_feature = 2
        AND energy_flag = 1
        <if test="standingbookIds != null and standingbookIds.size() != 0">
            AND standingbook_id IN
            <foreach collection="standingbookIds" item="id" open="(" separator="," close=")">
                #{id}
            </foreach>
        </if>
        <if test="paramCodes != null and paramCodes.size() != 0">
            AND param_code IN
            <foreach collection="paramCodes" item="paramCode" open="(" separator="," close=")">
                #{paramCode}
            </foreach>
        </if>
    </select>
</mapper>

